<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Parent Workout Log</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#2563eb" />
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%232563eb'/%3E%3Cpath d='M18 36h-4v-8h4v-4h6v16h-6v-4zm32 0h-4v4h-6V24h6v4h4v8zm-18 6h-2c-3 0-5-2-5-5V27c0-3 2-5 5-5h2c3 0 5 2 5 5v10c0 3-2 5-5 5z' fill='white'/%3E%3C/svg%3E" />
  <!-- Chart.js for graphs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" crossorigin="anonymous"></script>
  <style>
    :root{
      --bg:#f7f7fb; --card:#ffffff; --text:#1f2937; --muted:#6b7280; --accent:#2563eb;
      --ok:#059669; --warn:#d97706; --danger:#dc2626; --border:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',Arial;
      background:var(--bg); color:var(--text); line-height:1.4; }
    header{ position:sticky; top:0; z-index:10; background:var(--card); border-bottom:1px solid var(--border);
      padding:12px 16px; display:flex; gap:12px; align-items:center; justify-content:space-between; }
    h1{font-size:1.25rem; margin:0}
    nav{display:flex; gap:8px; flex-wrap:wrap}
    button, input, select, textarea{ font-size:1rem; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:#fff; color:var(--text); }
    button{cursor:pointer; border:0; background:var(--accent); color:#fff; font-weight:600}
    button.ghost{background:#fff; color:#1f2937; border:1px solid var(--border)}
    button.warn{background:var(--warn); color:#fff}
    button.danger{background:var(--danger)}
    main{max-width:1100px; margin:16px auto; padding:0 12px; display:grid; gap:16px}
    .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; box-shadow:0 1px 0 rgba(0,0,0,0.02); }
    .row{display:grid; gap:10px}
    @media(min-width:800px){ .row{grid-template-columns:1fr 1fr} }
    .exercise{ border:1px dashed var(--border); border-radius:12px; padding:12px; margin-top:10px; background:#fafafa; }
    .exercise header{display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:space-between; border:0; padding:0; background:transparent}
    .sets{display:grid; gap:8px; margin-top:8px}
    .set-row{display:grid; grid-template-columns:90px 1fr 1fr auto; gap:8px; align-items:center}
    .set-row select, .set-row input{width:100%}
    .muted{color:var(--muted); font-size:.95rem}
    .grid-3{display:grid; gap:10px}
    @media(min-width:900px){ .grid-3{grid-template-columns:1fr 1fr 1fr} }
    table{width:100%; border-collapse:collapse; font-size:0.95rem}
    th,td{border-bottom:1px solid var(--border); padding:10px; text-align:left; vertical-align:top}
    tr:hover td{background:#fafafa}
    .right{text-align:right}
    .stack-sm{display:flex; gap:8px; flex-wrap:wrap}
    .footer-tip{font-size:.9rem; color:var(--muted)}
    .chip{display:inline-block; padding:2px 8px; border-radius:999px; background:#eef2ff; color:#3730a3; font-size:.85rem; margin-left:6px}
    .custom-wrap{display:flex; gap:8px; margin-top:8px}
    .hidden{display:none !important;}
  </style>
</head>
<body>
<header>
  <h1>Parent Workout Log <span class="chip">offline • PWA</span></h1>
  <nav>
    <button class="ghost" id="tab-log">New Workout</button>
    <button class="ghost" id="tab-history">Past Workouts</button>
    <button class="ghost" id="tab-charts">Progress</button>
  </nav>
</header>

<main>
  <!-- NEW WORKOUT -->
  <section id="view-log" class="card" aria-labelledby="h-log">
    <h2 id="h-log">Log today’s workout</h2>
    <div class="grid-3">
      <label> Date
        <input type="date" id="w-date" />
      </label>
      <label> Start Time (optional)
        <input type="time" id="w-start" />
      </label>
      <label> Workout Duration (minutes)
        <input type="number" id="w-duration" min="0" step="1" inputmode="numeric" placeholder="e.g., 35" />
      </label>
    </div>

    <p class="muted" style="margin-top:6px">
      Up to 8 exercises. For each set, pick a weight (lb) and reps.
    </p>

    <div id="exercise-list"></div>

    <div class="stack-sm" style="margin-top:12px">
      <button type="button" id="add-ex" class="">+ Add Exercise</button>
      <button type="button" id="save" title="Save this workout">Save Workout</button>
      <button type="button" id="clear-form" class="ghost">Clear Form</button>
    </div>

    <p class="footer-tip">Tip: For bodyweight moves, leave weight blank (“—”) and just log reps.</p>
  </section>

  <!-- HISTORY -->
  <section id="view-history" class="card" aria-labelledby="h-history" hidden>
    <h2 id="h-history">Past workouts</h2>
    <div class="stack-sm" style="margin-bottom:8px">
      <button class="ghost" id="export-csv">Download CSV</button>
      <button class="ghost" id="export-json">Export Backup</button>
      <label class="stack-sm">
        <input type="file" id="import-json" accept="application/json" />
      </label>
      <button class="warn" id="share-latest">Share Latest</button>
      <button class="danger" id="wipe-all" title="Delete all data">Delete All</button>
    </div>
    <div style="overflow:auto">
      <table id="history-table" aria-describedby="history-help">
        <thead>
          <tr>
            <th>Date</th>
            <th>Duration</th>
            <th>Exercises (sets)</th>
            <th class="right">Volume (lb)</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="history-help" class="muted" style="margin-top:6px">Click “View” to see full details for a workout. “Edit” loads it back into the form.</div>
    </div>
  </section>

  <!-- CHARTS -->
  <section id="view-charts" class="card" aria-labelledby="h-charts" hidden>
    <h2 id="h-charts">Progress charts</h2>
    <div class="row">
      <div>
        <label>Choose exercise to chart
          <select id="chart-exercise"></select>
        </label>
        <p class="muted">Shows max weight (lb) and max reps per workout for the selected exercise.</p>
      </div>
      <div class="stack-sm" style="align-items:end">
        <button class="ghost" id="refresh-charts">Refresh</button>
      </div>
    </div>
    <div class="card" style="padding:10px; margin-top:10px">
      <canvas id="weightChart" height="220" aria-label="Weight over time"></canvas>
    </div>
    <div class="card" style="padding:10px">
      <canvas id="repChart" height="220" aria-label="Reps over time"></canvas>
    </div>
  </section>
</main>

<!-- SHARE MODAL -->
<div id="share-modal" hidden class="card" style="max-width:700px; margin:10px auto">
  <h3>Share this workout</h3>
  <textarea id="share-text" rows="8" style="width:100%"></textarea>
  <div class="stack-sm" style="margin-top:8px">
    <button id="copy-share" class="">Copy</button>
    <button id="email-share" class="ghost">Email</button>
    <button id="native-share" class="ghost">Share…</button>
    <button id="close-share" class="ghost">Close</button>
  </div>
</div>

<script>
/* ----------------- Utilities & Constants ----------------- */
const $  = (q, el=document)=>el.querySelector(q);
const $$ = (q, el=document)=>Array.from(el.querySelectorAll(q));
const STORAGE_KEY = 'parentWorkout.v2.lb';
const PRESET_KEY  = 'parentWorkout.presets.lb';

const DEFAULT_PRESETS = [
  "Chest Press",
  "Shoulder Press",
  "Single-Arm Row",
  "Overhead Tricep Extension",
  "Bicep Curl",
  "Squat"
];

const WEIGHT_OPTIONS = ["", 5,10,15,20,25]; // "" = bodyweight/none
const REP_OPTIONS = Array.from({length:15}, (_,i)=> i+1);

function todayISO(){
  const d = new Date();
  const tz = new Date(d.getTime() - d.getTimezoneOffset()*60000);
  return tz.toISOString().slice(0,10);
}
function toNumber(v){ const n = Number(v); return Number.isFinite(n)? n : null; }
function fmtDate(s){
  if(!s) return '';
  const d = new Date(s); if (isNaN(d)) return s;
  return d.toLocaleDateString();
}
function sum(arr){ return arr.reduce((a,b)=>a+b,0); }

/* ----------------- Preset Management ----------------- */
function loadPresets(){
  try{
    const raw = JSON.parse(localStorage.getItem(PRESET_KEY) || '[]');
    const merged = Array.from(new Set([...DEFAULT_PRESETS, ...raw])).filter(Boolean);
    return merged;
  }catch{
    return DEFAULT_PRESETS.slice();
  }
}
function savePresets(list){
  const customOnly = list.filter(p => !DEFAULT_PRESETS.map(x=>x.toLowerCase()).includes(p.toLowerCase()));
  localStorage.setItem(PRESET_KEY, JSON.stringify(customOnly));
}
function addPreset(name){
  const presets = loadPresets();
  const exists = presets.some(p => p.toLowerCase() === name.toLowerCase());
  if (!exists){
    presets.push(name);
    savePresets(presets);
    refreshExerciseSelectors();
  }
}

/* ----------------- Volume & Share ----------------- */
function computeVolume(ex){
  // Sum of (weight_lb * reps) across sets
  return sum((ex.sets||[]).map(s => (toNumber(s.weight)||0) * (toNumber(s.reps)||0)));
}
function workoutToText(w){
  const lines = [];
  lines.push(`Workout: ${fmtDate(w.date)}  •  Duration: ${w.duration||0} min`);
  w.exercises.forEach((ex,i)=>{
    const name = ex.name || `Exercise ${i+1}`;
    const detail = (ex.sets||[]).map(s=>{
      const wt = s.weight!==null && s.weight!=='' ? `${s.weight} lb` : 'BW';
      const r = s.reps ?? '';
      return `${wt}×${r}`;
    }).join(', ');
    lines.push(`- ${name}: ${detail}`);
  });
  const totalVol = sum(w.exercises.map(computeVolume));
  lines.push(`Total volume: ${Math.round(totalVol)} lb`);
  return lines.join('\n');
}

/* ----------------- Data Layer ----------------- */
function loadAll(){
  try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
  catch{ return []; }
}
function saveAll(list){ localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); }
function upsertWorkout(w){
  const list = loadAll();
  if (w.id){
    const idx = list.findIndex(x=>x.id===w.id);
    if (idx>=0) list[idx]=w; else list.push(w);
  } else {
    w.id = crypto.randomUUID();
    list.push(w);
  }
  saveAll(list);
  return w.id;
}
function deleteWorkout(id){
  saveAll(loadAll().filter(w=>w.id!==id));
}

/* ----------------- UI Builders ----------------- */
const exerciseMax = 8;
const exListEl = $('#exercise-list');
let editId = null;

function makeExerciseSelect(){
  const sel = document.createElement('select');
  sel.className = 'ex-select';
  sel.setAttribute('aria-label','Exercise');
  const presets = loadPresets();
  sel.innerHTML = [
    `<option value="" disabled selected>Select exercise…</option>`,
    ...presets.map(p => `<option value="${p}">${p}</option>`),
    `<option value="__custom__">Custom…</option>`
  ].join('');
  return sel;
}

function makeWeightSelect(){
  const sel = document.createElement('select');
  sel.className = 'set-weight';
  sel.setAttribute('aria-label','Weight (lb)');
  sel.innerHTML = WEIGHT_OPTIONS.map(v => {
    if (v === "") return `<option value="">—</option>`;
    return `<option value="${v}">${v} lb</option>`;
  }).join('');
  return sel;
}

function makeRepsSelect(){
  const sel = document.createElement('select');
  sel.className = 'set-reps';
  sel.setAttribute('aria-label','Reps');
  sel.innerHTML = [`<option value="" disabled selected>Reps</option>`]
    .concat(REP_OPTIONS.map(v=>`<option value="${v}">${v}</option>`))
    .join('');
  return sel;
}

function createSetRow(i){
  const row = document.createElement('div');
  row.className = 'set-row';
  row.innerHTML = `<div class="muted">Set ${i+1}</div>`;
  row.appendChild(makeWeightSelect());
  row.appendChild(makeRepsSelect());
  const del = document.createElement('button');
  del.type = 'button'; del.className='ghost remove-set'; del.textContent='✕';
  row.appendChild(del);
  return row;
}

function buildCustomControls(){
  const wrap = document.createElement('div');
  wrap.className = 'custom-wrap hidden';
  wrap.innerHTML = `
    <input type="text" class="custom-name" placeholder="Type exercise name" aria-label="Custom exercise name">
    <button type="button" class="ghost save-preset">Save as preset</button>
  `;
  return wrap;
}

function createExerciseBlock(index){
  const wrap = document.createElement('div');
  wrap.className = 'exercise';
  wrap.dataset.index = index;

  const header = document.createElement('header');
  const left = document.createElement('div');
  left.style.display='flex'; left.style.gap='8px'; left.style.alignItems='center'; left.style.flexWrap='wrap';
  const title = document.createElement('strong'); title.textContent = `Exercise ${index+1}`;
  const exSel = makeExerciseSelect();
  const customWrap = buildCustomControls();

  left.appendChild(title);
  left.appendChild(exSel);
  left.appendChild(customWrap);

  const right = document.createElement('div'); right.className='stack-sm';
  const addSetBtn = document.createElement('button'); addSetBtn.type='button'; addSetBtn.className='ghost add-set'; addSetBtn.textContent='+ Set';
  const removeExBtn = document.createElement('button'); removeExBtn.type='button'; removeExBtn.className='ghost remove-ex'; removeExBtn.textContent='Remove';
  right.appendChild(addSetBtn); right.appendChild(removeExBtn);

  header.appendChild(left); header.appendChild(right);

  const setsEl = document.createElement('div'); setsEl.className='sets';
  for (let i=0;i<3;i++) setsEl.appendChild(createSetRow(i));

  wrap.appendChild(header);
  wrap.appendChild(setsEl);

  // interactions
  wrap.addEventListener('click', (e)=>{
    if (e.target.classList.contains('add-set')){
      const count = $$('.set-row', setsEl).length;
      setsEl.appendChild(createSetRow(count));
    }
    if (e.target.classList.contains('remove-ex')){
      wrap.remove();
      renumberExercises();
      limitAddButton();
    }
    if (e.target.classList.contains('remove-set')){
      e.target.closest('.set-row').remove();
      renumberSets(setsEl);
    }
    if (e.target.classList.contains('save-preset')){
      const name = $('.custom-name', wrap).value.trim();
      if (!name){ alert('Type an exercise name first.'); return; }
      addPreset(name);
      // set select to the newly saved preset, hide custom box
      const sel = $('.ex-select', wrap);
      sel.value = name;
      $('.custom-wrap', wrap).classList.add('hidden');
      $('.custom-name', wrap).value = '';
    }
  });

  // toggle custom input visibility
  exSel.addEventListener('change', ()=>{
    const custom = $('.custom-wrap', wrap);
    if (exSel.value === '__custom__'){
      custom.classList.remove('hidden');
      $('.custom-name', wrap).focus();
    } else {
      custom.classList.add('hidden');
    }
  });

  return wrap;
}

function renumberSets(container){
  $$('.set-row', container).forEach((r,idx)=>{ $('.muted', r).textContent = `Set ${idx+1}`; });
}
function renumberExercises(){
  $$('.exercise', exListEl).forEach((ex,idx)=>{
    ex.dataset.index = idx;
    $('strong', ex).textContent = `Exercise ${idx+1}`;
  });
}
function limitAddButton(){
  const count = $$('.exercise', exListEl).length;
  $('#add-ex').disabled = count >= exerciseMax;
}

function refreshExerciseSelectors(){
  // Update all exercise <select>s with current preset list without dropping current values
  const presets = loadPresets();
  $$('.ex-select', exListEl).forEach(sel=>{
    const current = sel.value;
    sel.innerHTML = [
      `<option value="" disabled>Select exercise…</option>`,
      ...presets.map(p => `<option value="${p}">${p}</option>`),
      `<option value="__custom__">Custom…</option>`
    ].join('');
    // restore value or move to custom with text if needed
    if (current && presets.some(p => p.toLowerCase()===current.toLowerCase())){
      sel.value = presets.find(p => p.toLowerCase()===current.toLowerCase());
    } else if (current && current !== '__custom__' && current !== ''){
      sel.value = '__custom__';
      // reveal custom name with current value
      const wrap = sel.closest('.exercise');
      $('.custom-wrap', wrap).classList.remove('hidden');
      $('.custom-name', wrap).value = current;
    } else {
      sel.value = '';
    }
  });
}

/* ----------------- Form Read/Write ----------------- */
function readForm(){
  const date = $('#w-date').value || todayISO();
  const duration = toNumber($('#w-duration').value) ?? 0;
  const start = $('#w-start').value || null;

  const exercises = $$('.exercise', exListEl).map(ex=>{
    const sel = $('.ex-select', ex);
    let name = sel.value;
    if (name === '__custom__'){
      name = $('.custom-name', ex).value.trim();
    }
    name = name || ''; // empty if none
    const sets = $$('.set-row', ex).map(r=>({
      weight: toNumber($('.set-weight', r).value),
      reps: toNumber($('.set-reps', r).value),
    })).filter(s => s.weight!==null || s.reps!==null);
    return { name, sets };
  }).filter(e => e.name || e.sets.length);

  if (exercises.length===0) throw new Error('Please add at least one exercise.');
  return { id: editId || null, date, start, duration, exercises };
}

function writeForm(w){
  $('#w-date').value = w.date || todayISO();
  $('#w-start').value = w.start || '';
  $('#w-duration').value = w.duration ?? '';
  exListEl.innerHTML = '';
  (w.exercises||[]).slice(0,exerciseMax).forEach((ex, i)=>{
    const block = createExerciseBlock(i);
    const sel = $('.ex-select', block);
    const presets = loadPresets();
    if (ex.name && presets.some(p => p.toLowerCase()===ex.name.toLowerCase())){
      sel.value = presets.find(p => p.toLowerCase()===ex.name.toLowerCase());
    } else if (ex.name){
      sel.value = '__custom__';
      $('.custom-wrap', block).classList.remove('hidden');
      $('.custom-name', block).value = ex.name;
    }
    const setsEl = $('.sets', block);
    setsEl.innerHTML = '';
    (ex.sets||[]).forEach((s, j)=>{
      const r = createSetRow(j);
      if (s.weight !== null && s.weight !== undefined && s.weight !== ''){
        $('.set-weight', r).value = String(s.weight);
      }
      if (s.reps !== null && s.reps !== undefined && s.reps !== ''){
        $('.set-reps', r).value = String(s.reps);
      }
      setsEl.appendChild(r);
    });
    exListEl.appendChild(block);
  });
  limitAddButton();
}

function clearForm(){
  editId = null;
  $('#w-date').value = todayISO();
  $('#w-start').value = '';
  $('#w-duration').value = '';
  exListEl.innerHTML = '';
  for(let i=0;i<2;i++) exListEl.appendChild(createExerciseBlock(i));
  refreshExerciseSelectors();
  limitAddButton();
}

/* ----------------- History Table ----------------- */
function refreshHistory(){
  const tbody = $('#history-table tbody'); tbody.innerHTML = '';
  const list = loadAll().sort((a,b)=> (a.date||'').localeCompare(b.date||'')); // ascending
  list.forEach(w=>{
    const tr = document.createElement('tr');
    const flat = w.exercises.map(e => `${e.name||'Exercise'} (${e.sets.length})`).join(', ');
    const vol = sum(w.exercises.map(computeVolume));
    tr.innerHTML = `
      <td>${fmtDate(w.date)}</td>
      <td>${w.duration||0} min</td>
      <td>${flat}</td>
      <td class="right">${Math.round(vol)}</td>
      <td class="right">
        <div class="stack-sm" style="justify-content:flex-end">
          <button class="ghost view" data-id="${w.id}">View</button>
          <button class="ghost edit" data-id="${w.id}">Edit</button>
          <button class="ghost danger del" data-id="${w.id}">Delete</button>
          <button class="ghost share" data-id="${w.id}">Share</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });

  tbody.addEventListener('click', (e)=>{
    const id = e.target.dataset.id;
    if (!id) return;
    const list = loadAll();
    const w = list.find(x=>x.id===id);
    if (!w) return;

    if (e.target.classList.contains('view')){
      alert(workoutToText(w));
    }
    if (e.target.classList.contains('edit')){
      editId = w.id;
      switchTab('log');
      writeForm(w);
      window.scrollTo({top:0, behavior:'smooth'});
    }
    if (e.target.classList.contains('del')){
      if (confirm('Delete this workout?')){ deleteWorkout(id); refreshHistory(); refreshExerciseChoices(); drawCharts(); }
    }
    if (e.target.classList.contains('share')){
      openShare(workoutToText(w));
    }
  }, {once:true}); // reattach on refresh
}

/* ----------------- Charts ----------------- */
let weightChart, repChart;

function uniqueExerciseNames(){
  const names = new Set();
  loadAll().forEach(w=>{
    (w.exercises||[]).forEach(e=>{
      const n = (e.name||'').trim();
      if (n) names.add(n);
    });
  });
  return Array.from(names).sort((a,b)=>a.localeCompare(b));
}

function refreshExerciseChoices(){
  const sel = $('#chart-exercise');
  const current = sel.value;
  const names = uniqueExerciseNames();
  sel.innerHTML = names.length ? names.map(n=>`<option>${n}</option>`).join('') : `<option value="">(no data yet)</option>`;
  if (names.includes(current)) sel.value = current;
}

function getSeriesForExercise(name){
  const list = loadAll().slice().sort((a,b)=> (a.date||'').localeCompare(b.date||''));
  const labels = [], maxWeight = [], maxReps = [];
  list.forEach(w=>{
    const ex = (w.exercises||[]).find(e => (e.name||'').trim().toLowerCase() === name.toLowerCase());
    if (!ex) return;
    labels.push(fmtDate(w.date));
    const weights = ex.sets.map(s => toNumber(s.weight) ?? 0);
    const reps = ex.sets.map(s => toNumber(s.reps) ?? 0);
    maxWeight.push(weights.length? Math.max(...weights) : 0);
    maxReps.push(reps.length? Math.max(...reps) : 0);
  });
  return {labels, maxWeight, maxReps};
}

function makeLine(ctx, labels, data, label){
  return new Chart(ctx, {
    type:'line',
    data:{ labels, datasets:[{ label, data, tension:0.25, pointRadius:3 }]},
    options:{
      responsive:true, maintainAspectRatio:false,
      scales:{ x:{ ticks:{autoSkip:true,maxRotation:0}, grid:{display:false} } },
      plugins:{ legend:{display:true}, tooltip:{enabled:true} }
    }
  });
}

function drawCharts(){
  const name = $('#chart-exercise').value;
  if (!name){ return; }
  const {labels, maxWeight, maxReps} = getSeriesForExercise(name);

  if (weightChart){ weightChart.destroy(); }
  if (repChart){ repChart.destroy(); }

  weightChart = makeLine($('#weightChart'), labels, maxWeight, `${name}: Max Weight (lb)`);
  repChart   = makeLine($('#repChart'), labels, maxReps, `${name}: Max Reps`);
}

/* ----------------- Sharing ----------------- */
function openShare(text){
  $('#share-text').value = text;
  $('#share-modal').hidden = false;
  window.scrollTo({top:0, behavior:'smooth'});
}
function closeShare(){ $('#share-modal').hidden = true; }

$('#copy-share').addEventListener('click', async ()=>{
  const t = $('#share-text').value;
  try{ await navigator.clipboard.writeText(t); alert('Copied!'); } catch{ alert('Copy failed. You can select and copy manually.'); }
});
$('#email-share').addEventListener('click', ()=>{
  const body = encodeURIComponent($('#share-text').value);
  const subj = encodeURIComponent('Workout Log');
  window.location.href = `mailto:?subject=${subj}&body=${body}`;
});
$('#native-share').addEventListener('click', async ()=>{
  const t = $('#share-text').value;
  if (navigator.share){
    try{ await navigator.share({text:t}); } catch(e){}
  } else {
    alert('Native Share not available on this device. Use Copy or Email.');
  }
});
$('#close-share').addEventListener('click', closeShare);

/* ----------------- Export / Import ----------------- */
function toCSV(){
  const rows = [['id','date','duration_min','exercise','set_index','weight_lb','reps','volume_lb']];
  loadAll().forEach(w=>{
    (w.exercises||[]).forEach(ex=>{
      (ex.sets||[]).forEach((s,idx)=>{
        const vol = (toNumber(s.weight)||0)*(toNumber(s.reps)||0);
        rows.push([w.id, w.date, w.duration||0, (ex.name||'').replaceAll(',',';'), idx+1, s.weight??'', s.reps??'', vol]);
      });
    });
  });
  return rows.map(r => r.join(',')).join('\n');
}
function download(filename, text){
  const blob = new Blob([text], {type:'text/plain;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
  setTimeout(()=> URL.revokeObjectURL(url), 5000);
}

/* ----------------- Tabs & Events ----------------- */
function switchTab(name){
  $('#view-log').hidden = name!=='log';
  $('#view-history').hidden = name!=='history';
  $('#view-charts').hidden = name!=='charts';
  $('#tab-log').classList.toggle('ghost', name!=='log');
  $('#tab-history').classList.toggle('ghost', name!=='history');
  $('#tab-charts').classList.toggle('ghost', name!=='charts');
}
$('#tab-log').addEventListener('click', ()=>switchTab('log'));
$('#tab-history').addEventListener('click', ()=>{ refreshHistory(); switchTab('history'); });
$('#tab-charts').addEventListener('click', ()=>{ refreshExerciseChoices(); drawCharts(); switchTab('charts'); });

$('#add-ex').addEventListener('click', ()=>{
  const count = $$('.exercise', exListEl).length;
  if (count>=exerciseMax) return;
  exListEl.appendChild(createExerciseBlock(count));
  refreshExerciseSelectors();
  limitAddButton();
});

$('#save').addEventListener('click', ()=>{
  try{
    const w = readForm();
    upsertWorkout(w);
    alert('Saved!');
    clearForm();
    refreshExerciseChoices();
    refreshHistory();
  }catch(e){ alert(e.message || 'Please complete required fields.'); }
});

$('#clear-form').addEventListener('click', clearForm);

$('#export-csv').addEventListener('click', ()=>{ download('workouts.csv', toCSV()); });
$('#export-json').addEventListener('click', ()=>{ download('workouts-backup.json', JSON.stringify(loadAll(), null, 2)); });

$('#import-json').addEventListener('change', async (e)=>{
  const f = e.target.files?.[0]; if (!f) return;
  const text = await f.text();
  try{
    const data = JSON.parse(text);
    if (!Array.isArray(data)) throw new Error('Invalid file.');
    saveAll(data);
    alert('Imported!');
    refreshHistory(); refreshExerciseChoices(); drawCharts();
  }catch{ alert('Import failed.'); }
  e.target.value = '';
});

$('#refresh-charts').addEventListener('click', ()=>{ refreshExerciseChoices(); drawCharts(); });

$('#share-latest').addEventListener('click', ()=>{
  const list = loadAll().sort((a,b)=>(b.date||'').localeCompare(a.date||'')); // latest first
  if (!list.length){ alert('No workouts yet.'); return; }
  openShare(workoutToText(list[0]));
});

$('#wipe-all').addEventListener('click', ()=>{
  if (confirm('Delete ALL saved workouts from this browser?')){
    localStorage.removeItem(STORAGE_KEY);
    clearForm(); refreshHistory(); refreshExerciseChoices(); drawCharts();
  }
});

/* ----------------- Init ----------------- */
(function init(){
  clearForm();
  $('#w-date').value = todayISO();
  refreshHistory();
  refreshExerciseChoices();

  // Register service worker for PWA
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js');
    });
  }
})();
</script>
</body>
</html>

